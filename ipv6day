#!/usr/bin/perl

use strict;
use Net::DNS;
use Getopt::Std;

my %opts;

if (! getopt('t', \%opts) || $opts{'h'}) {
    usage();
    exit 1;
}

my $resolver = Net::DNS::Resolver->new;

print "<table>\n";
print "<thead><tr><th>Domain</th><th>DNS</th><th>WWW</th><th>MX</th><th>DNSKEY</th><th>DS</th></tr></thead>\n";
print "<tdata>\n";

foreach my $domain (@ARGV) {
    # strip any www. prefix
    $domain =~ s/^www\.//;

    Verbose("Checking $domain\n");

    print "  <tr>\n    <td><a href=\"http://www.$domain/\">$domain</a></td>\n";

    check_for_NS($domain);
    check_for_AAAA("www." . $domain, 1);
    check_for_MX($domain);
    check_for_generic($domain, 'DNSKEY');
    check_for_generic($domain, 'DS');
    print "  </tr>\n";
}

print "</tdata></table>\n";

sub check_for_NS {
    my ($name) = @_;
    my $count = 0;

    Verbose(" checking NS records\n");

    # Find the list of MX records for a name
    my $query = $resolver->search($name, "NS");

    if ($query) {
	foreach my $record ($query->answer) {
	    # for each NS record, find at least one that has an IPv6 address
	    $count += check_for_AAAA($record->nsdname);
	}
    }
    if ($count > 0) {
	Succeed($count);
	return $count;
    }
    # if we got here for any reason, we've failed
    Fail();
    return 0;
}

sub check_for_MX {
    my ($name) = @_;
    my $count = 0;

    Verbose(" checking MX records\n");
    # Find the list of MX records for a name
    my $query = $resolver->search($name, "MX");

    if ($query) {
	foreach my $record ($query->answer) {
	    # for each MX record, find at least one that has an IPv6 address
	    $count += check_for_AAAA($record->exchange);
	}
    }
    if ($count > 0) {
	Succeed($count);
	return $count;
    }
    # if we got here for any reason, we've failed
    Fail();
    return 0;
}

sub check_for_AAAA {
    my ($name, $printresults) = @_;
    my $count = 0;
    
    # test for an AAAA record for whatever was passed in
    my $query = $resolver->search($name, "AAAA");
    
    if ($query) {
	foreach my $record ($query->answer) {
	    next unless $record->type eq "AAAA";
	    Verbose("  found an AAAA record for $name");
	    $count++;
	}
	if ($count > 0) {
	    if ($printresults) {
		Succeed($count);
	    }
	    return $count;
	}
    } else {
	Verbose("  Query failed: ", $resolver->errorstring, "\n");
    }
    if ($printresults) {
	Fail();
    }
    return 0;
}

sub check_for_generic {
    my ($name, $type) = @_;
    my $count = 0;

    Verbose(" checking $type records\n");

    # Find the list of MX records for a name
    my $query = $resolver->search($name, $type);

    if ($query) {
	foreach my $record ($query->answer) {
	    $count++;
	}
    }
    if ($count > 0) {
	Succeed($count);
	return $count;
    }
    # if we got here for any reason, we've failed
    Fail();
    return 0;
}

sub Succeed {
    my ($addr) = @_;

    print "    <td bgcolor=\"40ff40\">$addr</td>\n";
}

sub Fail {
    my ($record) = @_;

    print "    <td bgcolor=\"red\">0</td>\n";
}

sub Warn {
    print STDERR @_;
}

sub Verbose {
    if ($opts{'v'}) {
	print STDERR @_;
    }
}

sub usage {
    print "ipv6day [-v] [-t]\n\n";
    print "Options:\n";
    print "\t-v\tVerbose Mode\n";
    print "\t-h\tHelp\n";
}
